name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

# Set permissions for the workflow
permissions:
  contents: read
  issues: read
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: [chrome, firefox]
        java-version: [11, 21]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Install dependencies
      run: mvn clean install -DskipTests
      
    - name: Run tests with ${{ matrix.browser }}
      run: mvn clean test -Dbrowser=${{ matrix.browser }} -Dtest=SauceDemoTest
      
    - name: Generate test report
      if: always()
      run: |
        mkdir -p test-results
        cp -r target/surefire-reports/* test-results/ || true
        cp -r target/reports/* test-results/ || true
        cp -r target/screenshots/* test-results/ || true
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.browser }}-java${{ matrix.java-version }}
        path: test-results/
        retention-days: 30
        
    - name: Publish test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: junit-results-${{ matrix.browser }}-java${{ matrix.java-version }}
        path: target/surefire-reports/*.xml
        
    - name: Generate test summary
      if: always()
      run: |
        echo "## üß™ Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Browser**: ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
        echo "**Java Version**: ${{ matrix.java-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "target/surefire-reports/TEST-org.test.selenium.SauceDemoTest.xml" ]; then
          tests=$(grep -o 'tests="[0-9]*"' target/surefire-reports/TEST-org.test.selenium.SauceDemoTest.xml | grep -o '[0-9]*')
          failures=$(grep -o 'failures="[0-9]*"' target/surefire-reports/TEST-org.test.selenium.SauceDemoTest.xml | grep -o '[0-9]*')
          errors=$(grep -o 'errors="[0-9]*"' target/surefire-reports/TEST-org.test.selenium.SauceDemoTest.xml | grep -o '[0-9]*')
          skipped=$(grep -o 'skipped="[0-9]*"' target/surefire-reports/TEST-org.test.selenium.SauceDemoTest.xml | grep -o '[0-9]*')
          
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Total Tests | $tests |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failures | $failures |" >> $GITHUB_STEP_SUMMARY
          echo "| üö® Errors | $errors |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚è≠Ô∏è Skipped | $skipped |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$failures" -eq 0 ] && [ "$errors" -eq 0 ]; then
            echo "## üéâ All Tests Passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Some Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ùå No test results found" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = './target/surefire-reports';
          
          let testSummary = '## üß™ Test Results\n\n';
          testSummary += `**Browser**: ${{ matrix.browser }}\n`;
          testSummary += `**Java Version**: ${{ matrix.java-version }}\n\n`;
          
          if (fs.existsSync(path)) {
            const files = fs.readdirSync(path);
            const xmlFiles = files.filter(f => f.endsWith('.xml'));
            
            let totalTests = 0;
            let totalFailures = 0;
            let totalErrors = 0;
            let totalSkipped = 0;
            
            xmlFiles.forEach(file => {
              const content = fs.readFileSync(`${path}/${file}`, 'utf8');
              const matches = content.match(/tests="(\d+)" failures="(\d+)" errors="(\d+)" skipped="(\d+)"/);
              if (matches) {
                totalTests += parseInt(matches[1]);
                totalFailures += parseInt(matches[2]);
                totalErrors += parseInt(matches[3]);
                totalSkipped += parseInt(matches[4]);
              }
            });
            
            testSummary += '### üìä Summary\n\n';
            testSummary += `| Metric | Count |\n`;
            testSummary += `|--------|-------|\n`;
            testSummary += `| ‚úÖ Total Tests | ${totalTests} |\n`;
            testSummary += `| ‚ùå Failures | ${totalFailures} |\n`;
            testSummary += `| üö® Errors | ${totalErrors} |\n`;
            testSummary += `| ‚è≠Ô∏è Skipped | ${totalSkipped} |\n`;
            
            const successRate = ((totalTests - totalFailures - totalErrors) / totalTests * 100).toFixed(1);
            testSummary += `| üìà Success Rate | ${successRate}% |\n\n`;
            
            if (totalFailures > 0 || totalErrors > 0) {
              testSummary += '### ‚ùå Failed Tests\n\n';
              testSummary += 'Check the [Artifacts section](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed reports and screenshots.\n';
            } else {
              testSummary += '### üéâ All Tests Passed!\n\n';
            }
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: testSummary
          });

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Build application
      run: mvn clean package -DskipTests
      
    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
        
    - name: Deploy to staging
      run: |
        echo "üöÄ Deploying to staging environment..."
        # Add your deployment commands here
        echo "‚úÖ Deployment completed successfully!"
